<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI é‡‘èæˆ°æƒ…å®¤ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. å…¨å±€æš—é»‘é¢¨æ ¼ --- */
        body { 
            background-color: #0d1117; /* æ·±ç°é»‘èƒŒæ™¯ */
            color: #c9d1d9; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh;
        }

        /* é ‚éƒ¨å°èˆª */
        .navbar {
            width: 100%; background-color: #161b22; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); position: sticky; top: 0; z-index: 100; box-sizing: border-box;
        }
        .app-title { font-size: 1.2rem; font-weight: bold; color: #58a6ff; display: flex; align-items: center; gap: 10px; }

        /* è¼¸å…¥å€å¡Š */
        .search-area {
            width: 95%; max-width: 600px; margin: 20px 0; display: flex; gap: 10px;
            background: #21262d; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); box-sizing: border-box;
        }
        input { 
            background: #0d1117; border: 1px solid #30363d; color: #fff; 
            padding: 12px; border-radius: 8px; font-size: 1rem; width: 100%; outline: none; box-sizing: border-box;
        }
        input:focus { border-color: #58a6ff; }

        /* --- 2. ä¹å®®æ ¼å„€è¡¨æ¿ (æ ¸å¿ƒé¸å–®) --- */
        .grid-menu {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            width: 95%; max-width: 600px; margin-bottom: 20px;
        }
        
        .menu-item {
            background-color: #21262d; border: 1px solid #30363d; border-radius: 12px;
            padding: 10px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; text-align: center; height: 75px;
        }
        .menu-item:active { transform: scale(0.95); background-color: #30363d; }
        .menu-item i { font-size: 1.5rem; margin-bottom: 8px; color: #8b949e; }
        .menu-item span { font-size: 0.75rem; color: #c9d1d9; font-weight: 500; }

        /* æŒ‰éˆ•é¡è‰²åˆ†é¡ */
        .menu-item.tech i { color: #58a6ff; }      /* æŠ€è¡“ (è—) */
        .menu-item.tool i { color: #f1c40f; }      /* å·¥å…· (é»ƒ) */
        .menu-item.fund i { color: #a371f7; }      /* åŸºæœ¬ (ç´«) */
        .menu-item.ai   i { color: #2ea043; }      /* AI (ç¶ ) */
        .menu-item.demon { background: linear-gradient(135deg, #1f2937, #000); border-color: #ff453a; }
        .menu-item.demon i { color: #ff453a; }     /* å¦–è‚¡ (ç´…) */
        
        /* ç®¡ç†å“¡åŒ¯å‡ºæŒ‰éˆ• */
        .menu-item.admin-export { background: #30363d; border-color: #8b949e; }
        .menu-item.admin-export i { color: #fff; }

        /* â˜… éš±è—å°ˆç”¨ class */
        .admin-hidden { display: none !important; }

        /* --- 3. çµæœå±•ç¤ºå¡ç‰‡ --- */
        #result-area { width: 95%; max-width: 600px; display: none; padding-bottom: 50px; }
        
        .card { background: #161b22; border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #30363d; position: relative; }
        
        /* è‚¡ç¥¨é ­éƒ¨è³‡è¨Š */
        .stock-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 15px; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        .stock-name { font-size: 1.1rem; color: #8b949e; }
        .price-tag { font-size: 1.8rem; font-weight: bold; color: #fff; }

        /* --- 4. ç‰¹æ•ˆï¼šè©•åˆ†åœ“ç’° --- */
        .score-container { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }
        .score-circle {
            width: 100px; height: 100px; border-radius: 50%;
            background: conic-gradient(#f39c12 0% 0%, #30363d 0% 100%);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .score-inner {
            width: 85px; height: 85px; background: #161b22; border-radius: 50%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .score-num { font-size: 2rem; font-weight: bold; color: #f39c12; }
        .score-label { font-size: 0.8rem; color: #8b949e; margin-top: -5px; }

        /* è¨Šè™Ÿç‡ˆæ–¹å¡Š */
        .signal-box { padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; border: 1px solid; }
        .sig-buy { background: rgba(46, 160, 67, 0.15); border-color: #2ea043; color: #3fb950; }
        .sig-sell { background: rgba(218, 54, 51, 0.15); border-color: #da3633; color: #f85149; }
        .sig-hold { background: rgba(210, 153, 34, 0.15); border-color: #d29922; color: #e3b341; }
        #signal-text { font-size: 1.5rem; font-weight: bold; }
        #signal-desc { margin-top: 5px; opacity: 0.8; font-size: 0.9rem; }

        /* --- 5. ç‰¹æ•ˆï¼šæ”¯æ’å£“åŠ›æ¢ --- */
        .sr-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .sr-row { 
            display: flex; align-items: center; justify-content: space-between;
            background: #0d1117; padding: 12px; border-radius: 8px; position: relative; overflow: hidden;
        }
        .sr-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
        .sr-bar.red { background-color: #ff453a; box-shadow: 2px 0 10px rgba(255, 69, 58, 0.3); }
        .sr-bar.green { background-color: #3fb950; box-shadow: 2px 0 10px rgba(63, 185, 80, 0.3); }
        .sr-left { display: flex; align-items: center; gap: 10px; margin-left: 10px; }
        .sr-price { font-size: 1.3rem; font-weight: bold; width: 90px; color: #e6edf3; }
        .sr-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: #0d1117; }
        .sr-badge.red { background-color: #ff453a; }
        .sr-badge.green { background-color: #3fb950; }
        .sr-right { text-align: right; }
        .sr-gap { font-size: 0.9rem; font-weight: bold; }
        .sr-source { font-size: 0.75rem; color: #8b949e; margin-top: 2px; }

        /* ä¸€èˆ¬ç¶²æ ¼ */
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .data-item { background: #0d1117; padding: 10px; border-radius: 6px; text-align: center; }
        .data-label { font-size: 0.75rem; color: #8b949e; margin-bottom: 4px; }
        .data-val { font-size: 1rem; font-weight: bold; color: #e6edf3; }

        /* å…è²¬è²æ˜ Footer */
        .footer-disclaimer {
            margin-top: auto; padding: 20px; text-align: center; font-size: 0.75rem; color: #484f58; width: 90%; max-width: 600px; border-top: 1px solid #21262d;
        }

        #loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: #58a6ff; padding: 20px 40px; border-radius: 12px; z-index: 999; font-size: 1.2rem; backdrop-filter: blur(5px); }

    </style>
</head>
<body>

    <div class="navbar">
        <div class="app-title"><i class="fa-solid fa-robot"></i> AI é‡‘èæˆ°æƒ…å®¤</div>
        <input type="text" id="access_code" placeholder="ğŸ”‘ é€šè¡Œç¢¼" style="width: 100px; padding: 8px; text-align: center;">
    </div>

    <div class="search-area">
        <div style="flex: 1;"><input type="text" id="code" placeholder="ä»£ç¢¼ (å¦‚: 2330)" value="2330"></div>
        <div style="flex: 1;"><input type="number" id="buy_price" placeholder="æˆæœ¬ (é¸å¡«)"></div>
    </div>

    <div class="grid-menu">
        <div class="menu-item tech" onclick="run('MA')"><i class="fa-solid fa-chart-line"></i><span>å‡ç·š MA</span></div>
        <div class="menu-item tech" onclick="run('KD')"><i class="fa-solid fa-water"></i><span>KD æŒ‡æ¨™</span></div>
        <div class="menu-item tech" onclick="run('MACD')"><i class="fa-solid fa-chart-simple"></i><span>MACD</span></div>
        <div class="menu-item tech" onclick="run('RSI')"><i class="fa-solid fa-bolt"></i><span>RSI</span></div>

        <div class="menu-item tool" onclick="run('SR')"><i class="fa-solid fa-layer-group"></i><span>æ”¯æ’å£“åŠ›</span></div>
        <div class="menu-item tool" onclick="run('FIB')"><i class="fa-solid fa-ruler-vertical"></i><span>æ–æ³¢é‚£å¥‘</span></div>
        <div class="menu-item tool" onclick="run('GAP')"><i class="fa-solid fa-arrows-up-down"></i><span>ç¼ºå£åˆ†æ</span></div>
        <div class="menu-item tool" onclick="run('PATTERN')"><i class="fa-solid fa-shapes"></i><span>å‹æ…‹è¾¨è­˜</span></div>

        <div class="menu-item tool" onclick="run('BOX')"><i class="fa-regular fa-square"></i><span>ç®±å‹ç†è«–</span></div>
        <div class="menu-item tool" onclick="run('REG')"><i class="fa-solid fa-road"></i><span>å›æ­¸é€šé“</span></div>
        <div class="menu-item tool" onclick="run('VALUE')"><i class="fa-solid fa-scale-balanced"></i><span>åƒ¹å€¼ä¼°ç®—</span></div>
        <div class="menu-item fund" onclick="run('CHIPS')"><i class="fa-solid fa-users-viewfinder"></i><span>ç±Œç¢¼åˆ†æ</span></div>
        
        <div class="menu-item fund" onclick="run('FINANCIAL')"><i class="fa-solid fa-file-invoice-dollar"></i><span>è²¡å ±ç‡Ÿæ”¶</span></div>
        <div class="menu-item ai" onclick="run('SUMMARY')" style="grid-column: span 3; background: linear-gradient(90deg, #161b22, #21262d);">
            <i class="fa-solid fa-microchip"></i><span>AI ç¶œåˆå¥æª¢è¨ºæ–·</span>
        </div>

        <div class="menu-item demon admin-hidden" onclick="run('DEMON')" style="grid-column: span 2; margin-top: 5px;">
            <i class="fa-solid fa-ghost"></i><span>å¦–è‚¡çµæ‰‹ (Admin)</span>
        </div>
        <div class="menu-item admin-export admin-hidden" onclick="exportData()" style="grid-column: span 2; margin-top: 5px;">
            <i class="fa-solid fa-file-csv"></i><span>åŒ¯å‡ºæµé‡å ±è¡¨</span>
        </div>
    </div>

    <div id="loading"><i class="fa-solid fa-circle-notch fa-spin"></i> AI é‹ç®—ä¸­...</div>

    <div id="result-area">
        <div class="card">
            <div class="stock-header">
                <span id="stock-name" class="stock-name">---</span>
                <span id="stock-price" class="price-tag">---</span>
            </div>
            
            <div id="score-card" class="score-container" style="display: none;">
                <div class="score-circle" id="score-circle-bg">
                    <div class="score-inner">
                        <div class="score-num" id="score-val">0</div>
                        <div class="score-label">AI è©•åˆ†</div>
                    </div>
                </div>
            </div>
            
            <div id="signal-box" class="signal-box sig-hold">
                <div id="signal-text">---</div>
                <div id="signal-desc">---</div>
            </div>

            <div id="vals-grid" class="data-grid"></div>
            
            <div id="sr-container" class="sr-list" style="display: none;"></div>
        </div>

        <div class="card" id="chart-card">
            <canvas id="mainChart" style="height: 250px;"></canvas>
        </div>
    </div>

    <div class="footer-disclaimer">
        æœ¬æœå‹™åƒ…ç‚º AI æŠ€è¡“ç ”ç©¶èˆ‡æ¸¬è©¦ç”¨é€”ï¼Œåˆ†æçµæœåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°ã€‚<br>
        ä½¿ç”¨è€…æ‡‰è‡ªè¡Œè©•ä¼°é¢¨éšªï¼Œæœ¬ç«™ä¸æ‰¿æ“”ä»»ä½•ç›ˆè™§è²¬ä»»ã€‚
    </div>

    <script>
        let myChart = null;

        const ADMIN_KEYS = ["RAY_ADMIN_888", "BOSS_001"]; 
        document.getElementById('access_code').addEventListener('input', function(e) {
            const inputVal = e.target.value.trim();
            const adminBtns = document.querySelectorAll('.admin-hidden');
            if (ADMIN_KEYS.includes(inputVal)) {
                adminBtns.forEach(btn => {
                    btn.classList.remove('admin-hidden');
                    btn.style.display = 'flex';
                });
            } else {
                adminBtns.forEach(btn => {
                    btn.classList.add('admin-hidden');
                    btn.style.display = 'none';
                });
            }
        });

        async function exportData() {
            const accessCode = document.getElementById('access_code').value;
            if (!accessCode) { alert("è«‹è¼¸å…¥ç®¡ç†å“¡é€šè¡Œç¢¼ï¼"); return; }
            try {
                const res = await fetch('/api/admin/export', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ access_code: accessCode })
                });
                if (res.status === 403) { alert("â›” æ¬Šé™ä¸è¶³ï¼"); return; }
                if (!res.ok) { alert("åŒ¯å‡ºå¤±æ•—"); return; }
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Traffic_Report_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                alert("âœ… å ±è¡¨ä¸‹è¼‰æˆåŠŸï¼");
            } catch (e) { alert("é€£ç·šéŒ¯èª¤: " + e); }
        }

        async function run(type) {
            const code = document.getElementById('code').value;
            const buyPrice = document.getElementById('buy_price').value;
            const accessCode = document.getElementById('access_code').value;
            
            if (type !== 'DEMON' && !code) { alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼"); return; }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('result-area').style.display = 'none';

            try {
                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code, type, buy_price: buyPrice, access_code: accessCode })
                });

                const data = await res.json();
                if (data.error) { alert(data.error); return; }

                renderUI(data, type);

            } catch (e) {
                alert("é€£ç·šéŒ¯èª¤: " + e);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderUI(data, type) {
            const info = data.info;
            const res = data.result;

            document.getElementById('stock-name').textContent = `${info.name} (${info.code})`;
            document.getElementById('stock-price').textContent = info.price;
            document.getElementById('result-area').style.display = 'block';

            const box = document.getElementById('signal-box');
            document.getElementById('signal-text').textContent = res.signal;
            document.getElementById('signal-desc').textContent = res.desc;
            box.className = 'signal-box';
            
            const sig = res.signal;
            if (sig.includes('è²·') || sig.includes('å¤š') || sig.includes('å¼·') || sig.includes('A') || sig.includes('å‘ä¸Š') || sig.includes('æŒ‘æˆ°å£“åŠ›')) {
                box.classList.add('sig-buy');
            } else if (sig.includes('è³£') || sig.includes('ç©º') || sig.includes('å¼±') || sig.includes('D') || sig.includes('å‘ä¸‹') || sig.includes('å›æ¸¬æ”¯æ’')) {
                box.classList.add('sig-sell');
            } else {
                box.classList.add('sig-hold');
            }

            const srContainer = document.getElementById('sr-container');
            const valsGrid = document.getElementById('vals-grid');
            const scoreCard = document.getElementById('score-card');
            
            srContainer.style.display = 'none';
            valsGrid.style.display = 'grid';
            scoreCard.style.display = 'none';

            if (type === 'SR') {
                valsGrid.style.display = 'none';
                srContainer.style.display = 'flex';
                srContainer.innerHTML = '';
                
                for (const [k, v] of Object.entries(res.vals)) {
                    if (k === 'ç¾åƒ¹') continue;
                    
                    const valStr = String(v);

                    if (valStr.includes('|')) {
                        const parts = valStr.split('|');
                        const price = parts[0];
                        const typeStr = parts[1];
                        const gap = parts[2];
                        const source = parts[3];
                        
                        const isRes = typeStr === 'å£“åŠ›';
                        const colorClass = isRes ? 'red' : 'green';
                        const gapColor = gap.includes('+') ? '#ff453a' : '#3fb950';

                        srContainer.innerHTML += `
                            <div class="sr-row">
                                <div class="sr-bar ${colorClass}"></div>
                                <div class="sr-left">
                                    <div class="sr-price" style="color:${isRes ? '#ff453a' : '#3fb950'}">${price}</div>
                                    <div class="sr-badge ${colorClass}">${typeStr}</div>
                                </div>
                                <div class="sr-right">
                                    <div class="sr-gap" style="color:${gapColor}">${gap}</div>
                                    <div class="sr-source">${source}</div>
                                </div>
                            </div>
                        `;
                    }
                    else {
                        if (k.includes('---')) continue; 
                        let colorStyle = '#c9d1d9';
                        if (valStr.includes('+') || valStr.includes('ç²åˆ©')) colorStyle = '#ff453a';
                        if (valStr.includes('-') || valStr.includes('è³ ') || valStr.includes('æ')) colorStyle = '#3fb950';

                        srContainer.innerHTML += `
                            <div class="sr-row" style="background: #1c2128; border: 1px dashed #30363d; min-height: 40px;">
                                <div class="sr-left" style="margin-left: 10px;">
                                    <div class="sr-source" style="font-size: 0.95rem; color: #8b949e;">${k}</div>
                                </div>
                                <div class="sr-right" style="margin-right: 10px;">
                                    <div class="sr-gap" style="color: ${colorStyle}; font-size: 1.1rem;">${valStr}</div>
                                </div>
                            </div>
                        `;
                    }
                }
            } 
            else {
                valsGrid.innerHTML = '';
                for (const [k, v] of Object.entries(res.vals)) {
                    if (k.includes('ç¸½åˆ†') || k.includes('è©•åˆ†')) {
                        const score = parseInt(String(v).replace(/[^0-9]/g, '')) || 0;
                        showScoreCircle(score);
                        continue;
                    }

                    let colorClass = '';
                    const vStr = String(v);
                    if(vStr.includes('+') || vStr.includes('è²·') || vStr.includes('å‘ä¸Š')) colorClass = 'color: #ff453a;';
                    if(vStr.includes('-') || vStr.includes('è³£') || vStr.includes('å‘ä¸‹')) colorClass = 'color: #3fb950;';
                    
                    valsGrid.innerHTML += `
                        <div class="data-item">
                            <div class="data-label">${k}</div>
                            <div class="data-val" style="${colorClass}">${v}</div>
                        </div>`;
                }
            }

            const chartCard = document.getElementById('chart-card');
            const noChartTypes = ['FINANCIAL', 'CHIPS', 'FIB', 'DEMON', 'SR', 'GAP', 'PATTERN'];
            
            if (noChartTypes.includes(type) || !data.chart) {
                chartCard.style.display = 'none';
            } else {
                chartCard.style.display = 'block';
                renderChart(data.chart);
            }
        }

        function showScoreCircle(score) {
            const container = document.getElementById('score-card');
            const bg = document.getElementById('score-circle-bg');
            const val = document.getElementById('score-val');
            container.style.display = 'flex';
            val.textContent = score;
            let color = '#f39c12';
            if (score >= 80) color = '#ff453a';
            if (score < 50) color = '#3fb950';
            val.style.color = color;
            bg.style.background = `conic-gradient(${color} 0% ${score}%, #30363d ${score}% 100%)`;
        }

        function renderChart(chartData) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (myChart) myChart.destroy();
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(88, 166, 255, 0.4)');
            gradient.addColorStop(1, 'rgba(88, 166, 255, 0)');

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.dates,
                    datasets: [{
                        label: 'è‚¡åƒ¹', data: chartData.prices,
                        borderColor: '#58a6ff', backgroundColor: gradient,
                        borderWidth: 2, fill: true, pointRadius: 0, tension: 0.1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { position: 'right', grid: { color: '#30363d' }, ticks: { color: '#8b949e' } } },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }
    </script>
</body>
</html>